# Elastic APM connector

The Elastic APM connector aggregates Elastic APM-specific metrics from signals.

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Distributions | [] |
| Warnings      | [Statefulness](#warnings) |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/elastic/opentelemetry-collector-components?query=is%3Aissue%20is%3Aopen%20label%3Aconnector%2Felasticapm%20&label=open&color=orange&logo=opentelemetry)](https://github.com/elastic/opentelemetry-collector-components/issues?q=is%3Aopen+is%3Aissue+label%3Aconnector%2Felasticapm) [![Closed issues](https://img.shields.io/github/issues-search/elastic/opentelemetry-collector-components?query=is%3Aissue%20is%3Aclosed%20label%3Aconnector%2Felasticapm%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/elastic/opentelemetry-collector-components/issues?q=is%3Aclosed+is%3Aissue+label%3Aconnector%2Felasticapm) |
| Code coverage | [![codecov](https://codecov.io/github/elastic/opentelemetry-collector-components/graph/main/badge.svg?component=connector_elasticapm)](https://app.codecov.io/gh/elastic/opentelemetry-collector-components/tree/main/?components%5B0%5D=connector_elasticapm&displayType=list) |

[development]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#development

## Supported Pipeline Types

| [Exporter Pipeline Type] | [Receiver Pipeline Type] | [Stability Level] |
| ------------------------ | ------------------------ | ----------------- |
| logs | metrics | [development] |
| metrics | metrics | [development] |
| traces | metrics | [development] |

[Exporter Pipeline Type]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/connector/README.md#exporter-pipeline-type
[Receiver Pipeline Type]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/connector/README.md#receiver-pipeline-type
[Stability Level]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#stability-levels
<!-- end autogenerated section -->

## Configuration

By design, this component has minimal configuration. An empty configuration will be functional
though we would not recommend this for production workloads; aggregation state should be stored
on disk to avoid extreme memory usage under high throughput.

By default, all aggregation state is maintained in-memory. The aggregation state can be stored
on disk instead by specifying `elasticapm::aggregation::directory`, which should be a directory
dedicated to this purpose.

By default, aggregated metrics will be exported without any client metadata. It is possible to
propagate client metadata from input to exported metrics by specifying a list of metadata keys
in `elasticapm::aggregation::metadata_keys`.

By default, cardinality for aggregated metrics will be limited.
Each limit defines a `max_cardinality`. There are four limits that can be configured: 
- `elasticapm::aggregation::limits::resource`: configures the max cardinality of resources
- `elasticapm::aggregation::limits::scope`: configures the max cardinality of scopes within a resource
- `elasticapm::aggregation::limits::metric`: configures the max cardinality of metrics within a scope
- `elasticapm::aggregation::limits::datapoint`: configures the max cardinality of datapoints within a metric

```yaml
elasticapm:
  aggregation:
    directory: /path/to/aggregation/directory
    metadata_keys: [list, of, metadata, keys]
    limits:
      resource: 
        max_cardinality: 8000
      scope:
        max_cardinality: 4000
      metric:
        max_cardinality: 4000
      datapoint:
        max_cardinality: 4000
```

### Metrics produced by the connector

| Metric                                          | Source Signal       | OTel Metric Type     | ES Mapping Type         |
| ----------------------------------------------- | ------------------- | -------------------- | ----------------------- |
| `service_summary`                               | Logs, Metric, Spans | Sum                  | Double                  |
| `span.destination.service.response_time.sum.us` | Spans               | Sum                  | Double                  |
| `span.destination.service.response_time.count`  | Spans               | Sum                  | Double                  |
| `transaction.duration.histogram`                | Spans               | Histogram            | [Histogram](https://www.elastic.co/guide/en/elasticsearch/reference/current/histogram.html)               |
| `transaction.duration.summary`                  | Spans               | Histogram (1 bucket) | [Aggregate Metric Double](https://www.elastic.co/guide/en/elasticsearch/reference/current/aggregate-metric-double.html) |
| `event.success_count`                           | Spans               | Histogram (1 bucket) | [Aggregate Metric Double](https://www.elastic.co/guide/en/elasticsearch/reference/current/aggregate-metric-double.html) |

Above is a list of metrics that are produced by the connector. There are few noteworthy points that needs to be documented:

1. [elasticsearch.mapping.hints](https://github.com/elastic/opentelemetry-dev/blob/main/docs/design-decisions/ingest/mapping.md#mapping-hints) attributes are used to bridge the gap for mapping OTel data types to Elasticsearch mappings.
2. `transaction.duration.{histogram, summary}` metrics are produced with different set of attributes to represent transaction duration grouped by transaction type or by more granular transaction attributes. These are identified by `metricset.name` attribute set to `service_transaction` or `transaction` respectively.
3. `event.success_count` metric is derived from the [enriched event.outcome attribute](https://github.com/elastic/opentelemetry-lib/blob/1b69a60c8a2c4f608527fa938dc4e3ab0b991089/enrichments/trace/internal/elastic/span.go#L356-L374). The metric is produced as a histograms with a single bucket where `count` represents the total number of spans and `value` represents the total number of spans with `event.outcome` as `success`. We use a histogram as it is the closest metric type that can be mapped to the aggregate metric double field in Elasticsearch. The [aggregate_metric_double mapping hint](https://github.com/elastic/opentelemetry-dev/blob/main/docs/design-decisions/ingest/mapping.md#mapping-hints) is added as an attribute to signal [Elasticsearch exporter](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/elasticsearchexporter) to do the conversion to aggregate metric double.
